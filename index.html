<!DOCTYPE html>
<html>
<head>
  <title>Radio Coverage Map</title>
  <meta charset="utf-8" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #controls {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 5px;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    input[type="text"] {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 250px;
    }

    .control-btn {
      padding: 6px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    #legend {
      background: white;
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 5;
      border-radius: 5px;
    }

    .legend-color {
      display: inline-block;
      width: 15px;
      height: 15px;
      margin-right: 6px;
      vertical-align: middle;
      border-radius: 3px;
    }

    .legend-color.station {
      background: #1E90FF;
    }

    .legend-color.store {
      background: #FF6347;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry"></script>
</head>
<body>
  <div id="controls">
    <input id="storeSearchBox" type="text" placeholder="Search for store (e.g. 97, #97, Burley)" />
    <button id="storeSearchBtn" class="control-btn">Search Store</button>
    <input id="stationSearchBox" type="text" placeholder="Search for station (e.g. KDIL)" />
    <button id="stationSearchBtn" class="control-btn">Search Station</button>
    <button id="resetBtn" class="control-btn">Reset</button>
  </div>

  <div id="map"></div>

  <div id="legend">
    <h3>Legend</h3>
    <p><span class="legend-color station"></span> Station</p>
    <p><span class="legend-color store"></span> Store</p>
  </div>

  <script>
    let map;
    const storeMarkers = [];
    const stationMarkers = [];
    const stationCircles = [];
    const stationData = [];       // NEW: will hold the loc object for each station
    let highlightedMarker = null;

    const colors = {
      "Station": "#1E90FF",
      "Store": "#FF6347"
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: { lat: 39.5, lng: -98.35 },
        gestureHandling: "greedy",
        disableDefaultUI: false
      });

      // One InfoWindow for stores and stations (we’ll change its contents dynamically)
      const hoverInfoWindow = new google.maps.InfoWindow();

      fetch('https://jzantow.github.io/radio-coverage/locations.json')
        .then(response => response.json())
        .then(locations => {
          locations.forEach(loc => {
            const position = { lat: loc.Latitude, lng: loc.Longitude };
            const color = colors[loc.Type] || "#000";

            // Create the coverage circle only for stations
            const circle = new google.maps.Circle({
              strokeColor: color,
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: color,
              fillOpacity: 0.25,
              map: loc.Type === "Station" ? map : null,
              center: position,
              radius: loc.Radius * 1609.34
            });

            // Create a marker for both stores and stations
            const marker = new google.maps.Marker({
              position,
              map,
              title: loc.Name,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillColor: color,
                fillOpacity: 1,
                strokeWeight: 1,
                strokeColor: "#fff"
              }
            });

            // If it’s a store → storeMarkers; if it’s a station → stationMarkers & stationCircles
            if (loc.Type === "Store") {
              // STORE: push marker, add hover & click listeners
              storeMarkers.push(marker);

              // On hover, show “In Range Of …”
              marker.addListener("mouseover", () => {
                const stationsInRange = stationCircles
                  .map((c, i) => {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                      new google.maps.LatLng(loc.Latitude, loc.Longitude),
                      c.getCenter()
                    );
                    if (distance <= c.getRadius()) {
                      // stationData[i] holds the loc for this circle
                      const st = stationData[i];
                      return `${st.Name} – ${st.Info}`;
                    }
                    return null;
                  })
                  .filter(Boolean);

                const content = `
                  <strong>${loc.Name}</strong><br>
                  <b>In Range Of:</b><br>
                  ${stationsInRange.length ? stationsInRange.join("<br>") : "None"}
                `;
                hoverInfoWindow.setContent(content);
                hoverInfoWindow.open(map, marker);
              });

              marker.addListener("mouseout", () => {
                hoverInfoWindow.close();
              });

              // On click, FILTER station markers/circles by “in‐range” and show InfoWindow listing them
              marker.addListener("click", () => {
                // First, compute which stations are in range
                const inRangeIndices = [];
                stationCircles.forEach((c, i) => {
                  const dist = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(loc.Latitude, loc.Longitude),
                    c.getCenter()
                  );
                  if (dist <= c.getRadius()) {
                    inRangeIndices.push(i);
                  }
                });

                // Show only those station markers/circles whose index is in inRangeIndices
                stationMarkers.forEach((m, idx) => {
                  if (inRangeIndices.includes(idx)) {
                    m.setMap(map);
                    stationCircles[idx].setMap(map);
                  } else {
                    m.setMap(null);
                    stationCircles[idx].setMap(null);
                  }
                });

                // Stores should remain visible, so we leave storeMarkers alone

                // Build content for InfoWindow
                const listedStations = inRangeIndices.map(i => {
                  const st = stationData[i];
                  return `${st.Name} – ${st.Info}`;
                });
                const infoHTML = `
                  <strong>${loc.Name}</strong><br>
                  <b>Stations In Range:</b><br>
                  ${listedStations.length ? listedStations.join("<br>") : "None"}
                `;

                hoverInfoWindow.setContent(infoHTML);
                hoverInfoWindow.open(map, marker);
              });

            } else if (loc.Type === "Station") {
              // STATION: store loc in stationData, push marker & circle, add click listener
              stationData.push(loc);
              stationMarkers.push(marker);
              stationCircles.push(circle);

              // On click, show station name
              marker.addListener("click", () => {
                hoverInfoWindow.setContent(`<strong>${loc.Name}</strong>`);
                hoverInfoWindow.open(map, marker);
              });
            }
          });
        });

      // === SEARCH STORE BUTTON ===
      document.getElementById("storeSearchBtn").addEventListener("click", () => {
        const value = document.getElementById("storeSearchBox").value.trim().toLowerCase();
        if (!value) return;

        const match = storeMarkers.find(marker => {
          const title = marker.getTitle().toLowerCase();
          const matchNum = title.match(/#?(\d+)/);
          return (
            title.includes(value) ||
            (matchNum && matchNum[1] === value.replace("#", ""))
          );
        });

        if (match) {
          map.setCenter(match.getPosition());
          map.setZoom(8);

          if (highlightedMarker) resetMarkerIcon(highlightedMarker);
          highlightedMarker = match;
          match.setIcon({
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#FFD700",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "#B8860B"
          });
        } else {
          alert("No matching store found.");
        }
      });

      // === SEARCH STATION BUTTON ===
      document.getElementById("stationSearchBtn").addEventListener("click", () => {
        const value = document.getElementById("stationSearchBox").value.trim().toLowerCase();
        if (!value) return;

        const match = stationMarkers.find(marker =>
          marker.getTitle().toLowerCase().includes(value)
        );

        if (match) {
          map.setCenter(match.getPosition());
          map.setZoom(8);
        } else {
          alert("No matching station found.");
        }
      });

      // === RESET BUTTON ===
      document.getElementById("resetBtn").addEventListener("click", () => {
        document.getElementById("storeSearchBox").value = "";
        document.getElementById("stationSearchBox").value = "";
        map.setZoom(5);
        map.setCenter({ lat: 39.5, lng: -98.35 });

        // Restore all station markers & circles
        stationMarkers.forEach(m => m.setMap(map));
        stationCircles.forEach(c => c.setMap(map));

        // Restore any highlighted store marker icon
        if (highlightedMarker) {
          resetMarkerIcon(highlightedMarker);
          highlightedMarker = null;
        }
      });
    }

    function resetMarkerIcon(marker) {
      marker.setIcon({
        path: google.maps.SymbolPath.CIRCLE,
        scale: 7,
        fillColor: "#FF6347",
        fillOpacity: 1,
        strokeWeight: 1,
        strokeColor: "#fff"
      });
    }

    window.onload = initMap;
  </script>
</body>
</html>
