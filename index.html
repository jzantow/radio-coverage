<!DOCTYPE html>
<html>
<head>
  <title>Radio Coverage Map (Minimal Store Click)</title>
  <meta charset="utf-8" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map { width: 100%; height: 100vh; }
    #legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 5;
      background: white;
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border-radius: 5px;
    }
    .legend-color {
      display: inline-block;
      width: 15px;
      height: 15px;
      margin-right: 6px;
      vertical-align: middle;
      border-radius: 3px;
    }
    .legend-color.station { background: #1E90FF; }
    .legend-color.store   { background: #FF6347; }
  </style>

  <!-- We include the geometry library so we can call computeDistanceBetween() -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry"></script>
</head>
<body>
  <div id="map"></div>

  <div id="legend">
    <h3>Legend</h3>
    <p><span class="legend-color station"></span> Station</p>
    <p><span class="legend-color store"></span> Store</p>
  </div>

  <script>
    let map;
    const storeMarkers   = [];
    const stationMarkers = [];
    const stationData    = []; // will hold raw {Name, Latitude, Longitude, Radius, Info} for each station

    const COLORS = {
      "Station": "#1E90FF",
      "Store":   "#FF6347"
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: { lat: 39.5, lng: -98.35 },
        gestureHandling: "greedy"
      });

      // A single InfoWindow for both stores and stations
      const infoWindow = new google.maps.InfoWindow();

      // 1) Fetch locations.json
      fetch('https://jzantow.github.io/radio-coverage/locations.json')
        .then(res => res.json())
        .then(locations => {
          // 2) First, build stationData[] and stationMarkers[] (we’ll also draw circles for visualization)
          locations.forEach(loc => {
            if (loc.Type === "Station") {
              stationData.push(loc);
            }
          });

          // 3) Now place markers (and circles) for every location
          locations.forEach(loc => {
            const position = { lat: loc.Latitude, lng: loc.Longitude };
            const color = COLORS[loc.Type] || "#000";

            // If it’s a station, draw its coverage circle as a visual aid (non-clickable)
            if (loc.Type === "Station") {
              new google.maps.Circle({
                strokeColor: color,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: color,
                fillOpacity: 0.25,
                center: position,
                radius: (loc.Radius || 0) * 1609.34,
                map: map,
                clickable: false
              });
            }

            // Create a marker for both Store & Station
            const marker = new google.maps.Marker({
              position: position,
              map: map,
              title: loc.Name,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillColor: color,
                fillOpacity: 1,
                strokeWeight: 1,
                strokeColor: "#fff"
              }
            });

            if (loc.Type === "Store") {
              // ─── STORE: attach click listener that loops over stationData[] ───
              storeMarkers.push(marker);

              marker.addListener("click", () => {
                console.log("STORE CLICK →", loc.Name);

                // Compute which stations are in range of this store
                const inRangeNames = stationData
                  .map(st => {
                    const storeLatLng   = new google.maps.LatLng(loc.Latitude, loc.Longitude);
                    const stationLatLng = new google.maps.LatLng(st.Latitude, st.Longitude);
                    const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(storeLatLng, stationLatLng);
                    const radiusMeters = (st.Radius || 0) * 1609.34;
                    if (distanceMeters <= radiusMeters) {
                      return st.Name;
                    }
                    return null;
                  })
                  .filter(name => name); // remove nulls

                // Build simple HTML for InfoWindow
                const content = `
                  <strong>${loc.Name}</strong><br>
                  <b>Stations In Range:</b><br>
                  ${inRangeNames.length ? inRangeNames.join("<br>") : "None"}
                `;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
              });

            } else if (loc.Type === "Station") {
              // ─── STATION: attach click listener that just pops up the station name ───
              stationMarkers.push(marker);

              marker.addListener("click", () => {
                infoWindow.setContent(`<strong>${loc.Name}</strong>`);
                infoWindow.open(map, marker);
              });
            }
          });
        })
        .catch(err => {
          console.error("ERROR loading locations.json:", err);
          alert("Could not load location data. See console.");
        });
    }

    window.onload = initMap;
  </script>
</body>
</html>
