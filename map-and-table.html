<!DOCTYPE html>
<html>
<head>
  <title>Radio Coverage Map with Table</title>
  <meta charset="utf-8" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 50vh;
      width: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    input[type="text"] {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 250px;
      margin-bottom: 5px;
    }
    .control-btn {
      padding: 6px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      user-select: none;
      margin-right: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #legend {
      background: white;
      padding: 10px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 5;
      border-radius: 5px;
    }
    .legend-color {
      display: inline-block;
      width: 15px;
      height: 15px;
      margin-right: 6px;
      vertical-align: middle;
      border-radius: 3px;
    }
    .legend-color.station {
      background: #1E90FF;
    }
    .legend-color.store {
      background: #FF6347;
    }
    #tableSection {
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry"></script>
</head>
<body>
  <div id="controls">
    <input id="storeSearchBox" type="text" placeholder="Search for store (e.g. 67, #67, name)" />
    <button id="storeSearchBtn" class="control-btn">Search Store</button>
    <input id="stationSearchBox" type="text" placeholder="Search for station (e.g. KUZZ)" />
    <button id="stationSearchBtn" class="control-btn">Search Station</button>
    <button id="resetBtn" class="control-btn">Reset</button>
  </div>

  <div id="map"></div>

  <div id="legend">
    <h3>Legend</h3>
    <p><span class="legend-color station"></span> Station</p>
    <p><span class="legend-color store"></span> Store</p>
  </div>

  <div id="tableSection">
    <h2>Stores and Stations in Range</h2>
    <input type="text" id="searchInput" placeholder="Search for a store...">
    <table>
      <thead>
        <tr><th>Store</th><th>Stations in Range</th></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    let map;
    let storeMarkers = [], stationMarkers = [], stationCircles = [], highlightedMarker = null;
    let locations = [];
    const colors = { Station: "#1E90FF", Store: "#FF6347" };

    function stripTags(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || div.innerText || '';
    }

    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: { lat: 39.5, lng: -98.35 }
      });

      const response = await fetch("https://jzantow.github.io/radio-coverage/locations.json");
      locations = await response.json();

      const hoverInfoWindow = new google.maps.InfoWindow();

      locations.forEach(loc => {
        const pos = { lat: loc.Latitude, lng: loc.Longitude };
        const color = colors[loc.Type] || "#000";
        const circle = new google.maps.Circle({
          strokeColor: color, strokeOpacity: 0.8, strokeWeight: 2,
          fillColor: color, fillOpacity: 0.25,
          map: loc.Type === "Station" ? map : null,
          center: pos,
          radius: loc.Radius * 1609.34
        });

        const marker = new google.maps.Marker({
          position: pos,
          map,
          title: loc.Name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 7,
            fillColor: color,
            fillOpacity: 1,
            strokeWeight: 1,
            strokeColor: "#fff"
          }
        });

        if (loc.Type === "Store") {
          storeMarkers.push(marker);
          marker.addListener("mouseover", () => {
            const inRange = stationCircles.map((c, i) => {
              const d = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(loc.Latitude, loc.Longitude), c.getCenter());
              if (d <= c.getRadius()) {
                const s = locations.find(l => l.Type === 'Station' && l.Latitude === c.getCenter().lat() && l.Longitude === c.getCenter().lng());
                return s ? `${s.Name} - ${stripTags(s.Info)}` : null;
              }
              return null;
            }).filter(Boolean);
            hoverInfoWindow.setContent(`<strong>${loc.Name}</strong><br><b>In Range Of:</b><br>${inRange.join("<br>") || "None"}`);
            hoverInfoWindow.open(map, marker);
          });
          marker.addListener("mouseout", () => hoverInfoWindow.close());
        } else {
          stationMarkers.push(marker);
          stationCircles.push(circle);
        }
      });

      document.getElementById("storeSearchBtn").onclick = () => {
        const value = document.getElementById("storeSearchBox").value.trim().toLowerCase();
        if (!value) return;
        const match = storeMarkers.find(m => {
          const t = m.getTitle().toLowerCase();
          const n = t.match(/#?(\d+)/);
          return t.includes(value) || (n && n[1] === value.replace("#", ""));
        });
        if (match) {
          map.setZoom(8);
          map.setCenter(match.getPosition());
          if (highlightedMarker) resetMarkerIcon(highlightedMarker);
          highlightedMarker = match;
          match.setIcon({ path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: "#FFD700", fillOpacity: 1, strokeWeight: 2, strokeColor: "#B8860B" });
        } else alert("No matching store found.");
      };

      document.getElementById("stationSearchBtn").onclick = () => {
        const value = document.getElementById("stationSearchBox").value.trim().toLowerCase();
        if (!value) return;
        const match = stationMarkers.find(m => m.getTitle().toLowerCase().includes(value));
        if (match) map.setZoom(8), map.setCenter(match.getPosition());
        else alert("No matching station found.");
      };

      document.getElementById("resetBtn").onclick = () => {
        document.getElementById("storeSearchBox").value = "";
        document.getElementById("stationSearchBox").value = "";
        map.setZoom(5);
        map.setCenter({ lat: 39.5, lng: -98.35 });
        if (highlightedMarker) resetMarkerIcon(highlightedMarker), highlightedMarker = null;
      };

      populateTable();
    }

    function resetMarkerIcon(marker) {
      marker.setIcon({
        path: google.maps.SymbolPath.CIRCLE,
        scale: 7,
        fillColor: colors["Store"],
        fillOpacity: 1,
        strokeWeight: 1,
        strokeColor: "#fff"
      });
    }

    function populateTable() {
      const tableBody = document.getElementById("tableBody");
      const stores = locations.filter(l => l.Type === "Store");
      const stations = locations.filter(l => l.Type === "Station");

      stores.forEach(store => {
        const storeLatLng = new google.maps.LatLng(store.Latitude, store.Longitude);
        const inRange = stations.filter(station => {
          const stationLatLng = new google.maps.LatLng(station.Latitude, station.Longitude);
          const radiusMeters = station.Radius * 1609.34;
          const distance = google.maps.geometry.spherical.computeDistanceBetween(storeLatLng, stationLatLng);
          return distance <= radiusMeters;
        });

        const row = document.createElement("tr");
        const storeCell = document.createElement("td");
        storeCell.textContent = store.Name;
        const stationCell = document.createElement("td");
        stationCell.innerHTML = inRange.length
          ? inRange.map(s => `${s.Name} â€“ ${stripTags(s.Info)}`).join("<br>")
          : "None";

        row.appendChild(storeCell);
        row.appendChild(stationCell);
        tableBody.appendChild(row);
      });

      document.getElementById("searchInput").addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach(row => {
          const name = row.cells[0].textContent.toLowerCase();
          row.style.display = name.includes(filter) ? "" : "none";
        });
      });
    }

    window.onload = initMap;
  </script>
</body>
</html>
