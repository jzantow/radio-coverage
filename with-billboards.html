<!DOCTYPE html>
<html>
<head>
  <title>Radio Coverage Map (with Billboard Search)</title>
  <meta charset="utf-8" />
  <style>
    html, body, #map {
      height: 100%; margin: 0; padding: 0;
    }
    #controls {
      position: absolute; top: 60px; left: 10px; z-index: 5;
      display: flex; flex-direction: column; gap: 5px;
      background: rgba(255,255,255,0.9); padding: 8px;
      border-radius: 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    input[type="text"] {
      padding: 6px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 4px;
      width: 250px;
    }
    .control-btn {
      padding: 6px 12px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 4px;
      background: white; cursor: pointer; user-select: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #legend {
      position: absolute; bottom: 10px; right: 10px; z-index: 5;
      background: white; padding: 10px; font-family: Arial;
      font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border-radius: 5px;
    }
    .legend-color {
      display: inline-block; width: 15px; height: 15px;
      margin-right: 6px; vertical-align: middle; border-radius: 3px;
    }
    .legend-color.station  { background: #1E90FF; }
    .legend-color.store    { background: #FF6347; }
    .legend-color.billboard{ background: #8A2BE2; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry"></script>
</head>
<body>
  <div id="controls">
    <input  id="storeSearchBox"     type="text" placeholder="Search store (e.g. #97, Burley)" />
    <button id="storeSearchBtn"     class="control-btn">Search Store</button>
    <input  id="stationSearchBox"   type="text" placeholder="Search station (e.g. KDIL)" />
    <button id="stationSearchBtn"   class="control-btn">Search Station</button>
    <input  id="billboardSearchBox" type="text" placeholder="Search billboard (ON #)" />
    <button id="billboardSearchBtn" class="control-btn">Search Billboard</button>
    <button id="resetBtn"           class="control-btn">Reset</button>
  </div>

  <div id="map"></div>

  <div id="legend">
    <h3>Legend</h3>
    <p><span class="legend-color.station"></span> Station</p>
    <p><span class="legend-color.store"></span> Store</p>
    <p><span class="legend-color.billboard"></span> Billboard</p>
  </div>

  <script>
    let map;
    const storeMarkers     = [];
    const stationMarkers   = [];
    const billboardMarkers = [];
    const stationData      = [];
    const billboardData    = [];
    let highlightedMarker  = null;

    const COLORS = {
      "Station":   "#1E90FF",
      "Store":     "#FF6347",
      "Billboard": "#8A2BE2"
    };

    function makeHighlightIcon() {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 7,
        fillColor: "#FFD700",
        fillOpacity: 1,
        strokeWeight: 1,
        strokeColor: "#B8860B"
      };
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: { lat: 42.53, lng: -114.36 },
        gestureHandling: "greedy",
        mapTypeControl: false
      });

      const infoWindow = new google.maps.InfoWindow();

      fetch('https://jzantow.github.io/radio-coverage/locations.json')
        .then(res => res.json())
        .then(locations => {
          // collect station & billboard data
          locations.forEach(loc => {
            if (loc.Type === "Station")   stationData.push(loc);
            if (loc.Type === "Billboard") billboardData.push(loc);
          });

          locations.forEach(loc => {
            const pos   = { lat: loc.Latitude, lng: loc.Longitude };
            const color = COLORS[loc.Type] || "#000";

            // draw coverage circle only for stations
            if (loc.Type === "Station") {
              new google.maps.Circle({
                strokeColor: color, strokeOpacity:0.8, strokeWeight:2,
                fillColor: color,  fillOpacity:0.25,
                center: pos, radius:(loc.Radius||0)*1609.34,
                map, clickable:false
              });
            }

            const defaultIcon = {
              path: google.maps.SymbolPath.CIRCLE,
              scale:7, fillColor:color, fillOpacity:1,
              strokeWeight:1, strokeColor:"#fff"
            };

            const marker = new google.maps.Marker({
              position: pos,
              map,
              title: loc.Name,
              icon: defaultIcon
            });
            marker.defaultIcon = defaultIcon;

            // STORE
            if (loc.Type === "Store") {
              storeMarkers.push(marker);
              marker.addListener("click", () => {
                toggleHighlight(marker, () => {
                  const inRange = stationData
                    .map(st => {
                      const d = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(loc.Latitude, loc.Longitude),
                        new google.maps.LatLng(st.Latitude, st.Longitude)
                      );
                      return d <= (st.Radius||0)*1609.34 ? st.Name : null;
                    })
                    .filter(n=>n);
                  infoWindow.setContent(`
                    <strong>${loc.Name}</strong><br>
                    <b>Stations In Range:</b><br>
                    ${inRange.length? inRange.join("<br>") : "None"}
                  `);
                  infoWindow.open(map, marker);
                });
              });

            // STATION
            } else if (loc.Type === "Station") {
              stationMarkers.push(marker);
              marker.addListener("click", () => {
                toggleHighlight(marker, () => {
                  infoWindow.setContent(`<strong>${loc.Name}</strong>`);
                  infoWindow.open(map, marker);
                });
              });

            // BILLBOARD
            } else if (loc.Type === "Billboard") {
              billboardMarkers.push(marker);
              marker.addListener("click", () => {
                toggleHighlight(marker, () => {
                  infoWindow.setContent(`
                    <strong>${loc.Name}</strong><br>
                    ${loc.Info||""}
                  `);
                  infoWindow.open(map, marker);
                });
              });
            }
          });
        });

      // helper: toggle or clear highlight then run showFn
      function toggleHighlight(marker, showFn) {
        if (highlightedMarker === marker) {
          highlightedMarker.setIcon(highlightedMarker.defaultIcon);
          highlightedMarker = null;
          infoWindow.close();
          return;
        }
        if (highlightedMarker) {
          highlightedMarker.setIcon(highlightedMarker.defaultIcon);
        }
        marker.setIcon(makeHighlightIcon());
        highlightedMarker = marker;
        showFn();
      }

      // SEARCH STORE
      document.getElementById("storeSearchBtn").addEventListener("click", () => {
        const q = document.getElementById("storeSearchBox").value.trim().toLowerCase();
        const match = storeMarkers.find(m=>{
          const t = m.getTitle().toLowerCase();
          const num = t.match(/#?(\d+)/);
          return t.includes(q) || (num && num[1]===q.replace("#",""));
        });
        if (!match) return alert("No matching store found.");
        map.setCenter(match.getPosition());
        map.setZoom(8);
        google.maps.event.trigger(match, "click");
      });

      // SEARCH STATION
      document.getElementById("stationSearchBtn").addEventListener("click", () => {
        const q = document.getElementById("stationSearchBox").value.trim().toLowerCase();
        const match = stationMarkers.find(m=>m.getTitle().toLowerCase().includes(q));
        if (!match) return alert("No matching station found.");
        map.setCenter(match.getPosition());
        map.setZoom(8);
        google.maps.event.trigger(match, "click");
      });

      // SEARCH BILLBOARD by ON #
      document.getElementById("billboardSearchBtn").addEventListener("click", () => {
        const q = document.getElementById("billboardSearchBox").value.trim().toLowerCase();
        const match = billboardMarkers.find(m=>m.getTitle().toLowerCase().includes(q));
        if (!match) return alert("No matching billboard found.");
        map.setCenter(match.getPosition());
        map.setZoom(8);
        google.maps.event.trigger(match, "click");
      });

      // RESET
      document.getElementById("resetBtn").addEventListener("click", () => {
        document.getElementById("storeSearchBox").value = "";
        document.getElementById("stationSearchBox").value = "";
        document.getElementById("billboardSearchBox").value = "";
        map.setCenter({ lat: 42.53, lng: -114.36 });
        map.setZoom(5);
        if (highlightedMarker) {
          highlightedMarker.setIcon(highlightedMarker.defaultIcon);
          highlightedMarker = null;
        }
      });
    }

    window.onload = initMap;
  </script>
</body>
</html>
